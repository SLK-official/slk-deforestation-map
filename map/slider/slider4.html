<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Display a map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <!-- Mapbox -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.1.0/nouislider.min.css" />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.1.0/nouislider.min.js'></script>

    <!-- Moment.js -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>

    <style>
    /* ============================================
       COLOR PALETTE - Define all year colors here
       ============================================ */
    :root {
        --color-2001: #FFE5E5;  /* Very light red */
        --color-2002: #FFCCCC;  /* Light red */
        --color-2003: #FFB3B3;  /* Light red */
        --color-2004: #FF9999;  /* Light-medium red */
        --color-2005: #FF8080;  /* Light-medium red */
        --color-2006: #FF6666;  /* Medium-light red */
        --color-2007: #FF4D4D;  /* Medium-light red */
        --color-2008: #FF3333;  /* Medium red */
        --color-2009: #FF1A1A;  /* Medium red */
        --color-2010: #FF0000;  /* Red */
        --color-2011: #E60000;  /* Medium-dark red */
        --color-2012: #CC0000;  /* Medium-dark red */
        --color-2013: #B30000;  /* Dark red */
        --color-2014: #990000;  /* Dark red */
        --color-2015: #800000;  /* Dark red */
        --color-2016: #660000;  /* Very dark red */
        --color-2017: #4D0000;  /* Very dark red */
        --color-2018: #330000;  /* Very dark red */
        --color-2019: #1A0000;  /* Almost black red */
        --color-2020: #140000;  /* Darker */
        --color-2021: #0F0000;  /* Darker */
        --color-2022: #0A0000;  /* Very dark */
        --color-2023: #050000;  /* Near black */
        --color-2024: #030000;  /* Darkest (almost black) */
        --color-default: #b83735;
    }

    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }

    .slider-control-container {
        padding: 5px;       
        max-width: 100%;
        box-sizing: border-box;
    }

    .slider-control-range-display {
        font-size: 18px;
        padding-top: 5px;
        padding-bottom: 5px;
        font-weight: 700;
        background-color: #FFF;
        border-radius: 5px;
    }

    /* Center the slider at the bottom */
    .mapboxgl-ctrl-bottom-left {
        left: 50%;
        transform: translateX(-50%);
        bottom: 20px;
    }

    /* Slider bar gradient legend - gradient set dynamically via JS */
    #slider-control.noUi-target,
    #slider-control.noUi-target .noUi-base {
        border: none !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;
        height: 14px !important;
        position: relative;
        border-radius: 4px 4px 4px 4px;
    }

    #slider-control .noUi-connect,
    #slider-control .noUi-connects {
        background: transparent !important;
    }

    /* Overlays to dim colors outside selected range - defined BEFORE controls */
    .slider-overlay {
        position: absolute;
        top: 0;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        pointer-events: none;
        z-index: 1;
    }
    .slider-overlay-left {
        left: 0;
        border-radius: 4px 0 0 4px;
    }
    .slider-overlay-right {
        right: 0;
        border-radius: 0 4px 4px 0;
    }

    /* Controls - defined AFTER overlays to appear on top */
    #slider-control .noUi-origin {
        z-index: 2 !important;
    }

    #slider-control .noUi-handle {
        border: 1px solid #333 !important;
        background: #fff !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;
        border-radius: 4px 4px 4px 4px;
    }

    /* Year labels under slider */
    .slider-year-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #333;
        margin-top: 5px;
        font-weight: 600;
    }

    /* Mobile responsiveness */
    @media (max-width: 480px) {
        .mapboxgl-ctrl-bottom-left {
            bottom: 10px;
            left: 50%;
            right: auto;
            width: calc(100% - 30px);
            max-width: 400px;
        }
        
        .slider-control-range-display {
            font-size: 14px;
        }
        
        .slider-year-labels {
            font-size: 10px;
        }
    }
    </style>
</head>

<body>
    <div id='map'></div>
    <script src="rangeSlider.js"></script>
    <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2xrb3Nvdm8iLCJhIjoiY2tuc3YwNjNuMTJnNDJ1cXdhazVydDZ2cSJ9.QEeEU3pdlV2hBg245jVTJg';
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/outdoors-v11', // stylesheet location
        center: [20.45710490014006, 42.59902581127422], // starting position [lng, lat]
        zoom: 12 // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    // disable map rotation using right click + drag
    map.dragRotate.disable();

    // disable map rotation using touch rotation gesture
    map.touchZoomRotate.disableRotation();

    // Year range configuration
    const MIN_YEAR = 2001;
    const MAX_YEAR = 2024;

    // Get CSS custom property value
    function getCSSColor(varName) {
        return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    }

    // Get color for a specific year (reads from CSS variables)
    function getYearColor(year) {
        const color = getCSSColor(`--color-${year}`);
        return color || getCSSColor('--color-default');
    }

    // Generate CSS gradient string from CSS variables
    function generateGradientCSS() {
        const range = MAX_YEAR - MIN_YEAR;
        const stops = [];

        for (let year = MIN_YEAR; year <= MAX_YEAR; year++) {
            const percent = ((year - MIN_YEAR) / range) * 100;
            stops.push(`${getYearColor(year)} ${percent.toFixed(2)}%`);
        }

        return `linear-gradient(to right, ${stops.join(', ')})`;
    }

    // Apply gradient to slider element
    function applySliderGradient() {
        const sliderElement = document.getElementById('slider-control');
        if (!sliderElement) {
            setTimeout(applySliderGradient, 100);
            return;
        }
        const gradient = generateGradientCSS();
        sliderElement.style.background = gradient;
        const noUiBase = sliderElement.querySelector('.noUi-base');
        if (noUiBase) {
            noUiBase.style.background = gradient;
        }
    }
    // Create color expression for Mapbox
    function createColorExpression() {
        // Build a case expression that maps each year to its color
        const cases = [];
        for (let year = MIN_YEAR; year <= MAX_YEAR; year++) {
            cases.push(['==', ['number', ['get', 'year']], year]);
            cases.push(getYearColor(year));
        }
        cases.push(getCSSColor('--color-default'));
        
        return ['case', ...cases];
    }

    var sliderOptions = {
        elm: 'slider-control',
        layer: 'forest_layer',
        source: 'forest_source',
        controlWidth: 'min(400px, calc(100vw - 40px))',
        minProperty: 'year',
        maxProperty: 'year',
        sliderMin: 2001,
        sliderMax: 2024,
        filterMin: 2001,
        filterMax: 2024,
        propertyType: 'integer',
        rangeDescriptionFormat: 'integer',
        descriptionPrefix: 'Year:'
    }

    map.addControl(new RangeSlider(sliderOptions, 'bottom-left'));

    // Add year labels under the slider
    function addSliderYearLabels() {
        const sliderElement = document.getElementById('slider-control');
        if (sliderElement) {
            const labelsDiv = document.createElement('div');
            labelsDiv.className = 'slider-year-labels';
            labelsDiv.innerHTML = '<span>2001</span><span>2024</span>';
            sliderElement.parentNode.insertBefore(labelsDiv, sliderElement.nextSibling);
        } else {
            setTimeout(addSliderYearLabels, 100);
        }
    }

    // Add overlays to dim colors outside selected range
    function setupSliderOverlays() {
        const sliderElement = document.getElementById('slider-control');
        if (!sliderElement || !sliderElement.noUiSlider) {
            setTimeout(setupSliderOverlays, 100);
            return;
        }

        // Create overlay elements
        const leftOverlay = document.createElement('div');
        leftOverlay.className = 'slider-overlay slider-overlay-left';
        const rightOverlay = document.createElement('div');
        rightOverlay.className = 'slider-overlay slider-overlay-right';

        // Append to .noUi-base to be in same stacking context as handles
        const noUiBase = sliderElement.querySelector('.noUi-base');
        noUiBase.appendChild(leftOverlay);
        noUiBase.appendChild(rightOverlay);

        // Update overlays based on slider values
        function updateOverlays() {
            const values = sliderElement.noUiSlider.get();
            const minVal = parseFloat(values[0]);
            const maxVal = parseFloat(values[1]);
            
            // Calculate percentages (2001-2024 range = 23 years)
            const sliderMin = 2001;
            const sliderMax = 2024;
            const range = sliderMax - sliderMin;
            
            const leftPercent = ((minVal - sliderMin) / range) * 100;
            const rightPercent = ((sliderMax - maxVal) / range) * 100;

            leftOverlay.style.width = leftPercent + '%';
            rightOverlay.style.width = rightPercent + '%';
        }

        // Initial update
        updateOverlays();

        // Update on slider change
        sliderElement.noUiSlider.on('update', updateOverlays);
    }

    map.on('load', function () {
        map.addSource('forest_source', { 
            type: 'geojson', 
            data: './deforestation/merged_slk.geojson'
        });
        
        map.addLayer({
            'id': 'forest_layer',
            'source': 'forest_source',
            'type': 'fill',
            'paint': {
                'fill-color': createColorExpression(),
                'fill-opacity': 1
            }
        });

        // Apply gradient from centralized color palette
        applySliderGradient();

        // Add year labels after slider is ready
        addSliderYearLabels();
        
        // Setup overlays to dim colors outside range
        setupSliderOverlays();
    });



    </script>
</body>

</html>