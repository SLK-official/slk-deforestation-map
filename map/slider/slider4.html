<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Display a map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <!-- Mapbox -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.1.0/nouislider.min.css" />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.1.0/nouislider.min.js'></script>

    <!-- Moment.js -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>

    <style>
    body {
        margin: 0;
        padding: 0;
    }

    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }

    .slider-control-container {
        padding: 5px;
    }

    .slider-control-range-display {
        font-size: 18px;
        padding-top: 5px;
        padding-bottom: 5px;
        font-weight: 700;
        background-color: #FFF;
        border-radius: 5px;
    }

    /* Center the slider at the bottom */
    .mapboxgl-ctrl-bottom-left {
        left: 50%;
        transform: translateX(-50%);
        bottom: 20px;
    }

    /* Slider bar gradient legend */
    #slider-control.noUi-target,
    #slider-control.noUi-target .noUi-base {
        background: linear-gradient(to right,
            #FFE5E5 0%,      /* 2001 */
            #FFCCCC 4.35%,   /* 2002 */
            #FFB3B3 8.7%,    /* 2003 */
            #FF9999 13.04%,  /* 2004 */
            #FF8080 17.39%,  /* 2005 */
            #FF6666 21.74%,  /* 2006 */
            #FF4D4D 26.09%,  /* 2007 */
            #FF3333 30.43%,  /* 2008 */
            #FF1A1A 34.78%,  /* 2009 */
            #FF0000 39.13%,  /* 2010 */
            #E60000 43.48%,  /* 2011 */
            #CC0000 47.83%,  /* 2012 */
            #B30000 52.17%,  /* 2013 */
            #990000 56.52%,  /* 2014 */
            #800000 60.87%,  /* 2015 */
            #660000 65.22%,  /* 2016 */
            #4D0000 69.57%,  /* 2017 */
            #330000 73.91%,  /* 2018 */
            #1A0000 78.26%,  /* 2019 */
            #660000 86.96%,  /* 2022 */
            #4D0000 91.3%,   /* 2023 */
            #330000 100%     /* 2024 */
        ) !important;
        border: none !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;
        height: 14px !important;
    }

    #slider-control .noUi-connect,
    #slider-control .noUi-connects {
        background: transparent !important;
    }

    #slider-control .noUi-handle {
        border: 2px solid #333 !important;
        background: #fff !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;
    }

    /* Year labels under slider */
    .slider-year-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #333;
        margin-top: 5px;
        font-weight: 600;
    }

    /* Overlays to dim colors outside selected range */
    .slider-overlay {
        position: absolute;
        top: 0;
        height: 100%;
        background: rgba(255, 255, 255, 0.75);
        pointer-events: none;
        z-index: 1;
    }
    .slider-overlay-left {
        left: 0;
        border-radius: 4px 0 0 4px;
    }
    .slider-overlay-right {
        right: 0;
        border-radius: 0 4px 4px 0;
    }

    /* Ensure slider container has relative positioning */
    #slider-control.noUi-target {
        position: relative;
    }
    </style>
</head>

<body>
    <div id='map'></div>
    <script src="rangeSlider.js"></script>
    <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2xrb3Nvdm8iLCJhIjoiY2tuc3YwNjNuMTJnNDJ1cXdhazVydDZ2cSJ9.QEeEU3pdlV2hBg245jVTJg';
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/outdoors-v11', // stylesheet location
        center: [20.45710490014006, 42.59902581127422], // starting position [lng, lat]
        zoom: 12 // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    // disable map rotation using right click + drag
    map.dragRotate.disable();

    // disable map rotation using touch rotation gesture
    map.touchZoomRotate.disableRotation();

     // Color palette function - generates distinct colors for each year
     function getYearColor(year) {
            // Red gradient from light (2001) to dark (2024)
            const colors = {
                2001: '#FFE5E5',  // Very light red
                2002: '#FFCCCC',  // Light red
                2003: '#FFB3B3',  // Light red
                2004: '#FF9999',  // Light-medium red
                2005: '#FF8080',  // Light-medium red
                2006: '#FF6666',  // Medium-light red
                2007: '#FF4D4D',  // Medium-light red
                2008: '#FF3333',  // Medium red
                2009: '#FF1A1A',  // Medium red
                2010: '#FF0000',  // Red
                2011: '#E60000',  // Medium-dark red
                2012: '#CC0000',  // Medium-dark red
                2013: '#B30000',  // Dark red
                2014: '#990000',  // Dark red
                2015: '#800000',  // Dark red
                2016: '#660000',  // Very dark red
                2017: '#4D0000',  // Very dark red
                2018: '#330000',  // Very dark red
                2019: '#1A0000',  // Almost black red
                2020: '#8B0000',  // Dark red (maroon)
                2021: '#7A0000',  // Darker maroon
                2022: '#660000',  // Very dark red
                2023: '#4D0000',  // Very dark red
                2024: '#330000'   // Darkest red (almost black)
            };
            
            return colors[year] || '#b83735'; // Default color if year not found
        }
    // Create color expression for Mapbox
    function createColorExpression() {
            // Build a case expression that maps each year to its color
            const cases = [];
            for (let year = 2001; year <= 2024; year++) {
                cases.push(['==', ['number', ['get', 'year']], year]);
                cases.push(getYearColor(year));
            }
            cases.push('#b83735'); // Default color
            
            return ['case', ...cases];
        }

    var sliderOptions = {
        elm: 'slider-control',
        layer: 'forest_layer',
        source: 'forest_source',
        controlWidth: '400px',
        minProperty: 'year',
        maxProperty: 'year',
        sliderMin: 2001,
        sliderMax: 2024,
        filterMin: 2001,
        filterMax: 2024,
        propertyType: 'integer',
        rangeDescriptionFormat: 'integer',
        descriptionPrefix: 'Year:'
    }

    map.addControl(new RangeSlider(sliderOptions, 'bottom-left'));

    // Add year labels under the slider
    function addSliderYearLabels() {
        const sliderElement = document.getElementById('slider-control');
        if (sliderElement) {
            const labelsDiv = document.createElement('div');
            labelsDiv.className = 'slider-year-labels';
            labelsDiv.innerHTML = '<span>2001</span><span>2024</span>';
            sliderElement.parentNode.insertBefore(labelsDiv, sliderElement.nextSibling);
        } else {
            setTimeout(addSliderYearLabels, 100);
        }
    }

    // Add overlays to dim colors outside selected range
    function setupSliderOverlays() {
        const sliderElement = document.getElementById('slider-control');
        if (!sliderElement || !sliderElement.noUiSlider) {
            setTimeout(setupSliderOverlays, 100);
            return;
        }

        // Create overlay elements
        const leftOverlay = document.createElement('div');
        leftOverlay.className = 'slider-overlay slider-overlay-left';
        const rightOverlay = document.createElement('div');
        rightOverlay.className = 'slider-overlay slider-overlay-right';

        sliderElement.appendChild(leftOverlay);
        sliderElement.appendChild(rightOverlay);

        // Update overlays based on slider values
        function updateOverlays() {
            const values = sliderElement.noUiSlider.get();
            const minVal = parseFloat(values[0]);
            const maxVal = parseFloat(values[1]);
            
            // Calculate percentages (2001-2024 range = 23 years)
            const sliderMin = 2001;
            const sliderMax = 2024;
            const range = sliderMax - sliderMin;
            
            const leftPercent = ((minVal - sliderMin) / range) * 100;
            const rightPercent = ((sliderMax - maxVal) / range) * 100;

            leftOverlay.style.width = leftPercent + '%';
            rightOverlay.style.width = rightPercent + '%';
        }

        // Initial update
        updateOverlays();

        // Update on slider change
        sliderElement.noUiSlider.on('update', updateOverlays);
    }

    map.on('load', function () {
        map.addSource('forest_source', { 
            type: 'geojson', 
            data: './deforestation/merged_slk.geojson'
        });
        
        map.addLayer({
            'id': 'forest_layer',
            'source': 'forest_source',
            'type': 'fill',
            'paint': {
                'fill-color': createColorExpression(),
                'fill-opacity': 1
            }
        });

        // Add year labels after slider is ready
        addSliderYearLabels();
        
        // Setup overlays to dim colors outside range
        setupSliderOverlays();
    });



    </script>
</body>

</html>