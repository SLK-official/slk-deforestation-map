<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Slider</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Nunito Sans', Helvetica, Arial, Sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        h1 {
            font-size: 20px;
            line-height: 30px;
        }

        a {
            text-decoration: none;
            color: #2dc4b2;
        }

        #console {
            width: 320px;
            background: linear-gradient(142deg, rgba(53,175,184,1) 0%, rgba(134,207,212,1) 100%);
            position: absolute;
            bottom: 0;
            left: 50%;
            margin-left: -160px;
            margin-bottom: 1%;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header-title {
            font-size: 14px;
            font-weight: bold;
            color: #2F3E54;
        }

        .year-range-display {
            font-size: 14px;
            color: #2F3E54;
            font-weight: 500;
        }

        .reset-button {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #2F3E54;
            padding: 0 5px;
            line-height: 1;
            transition: transform 0.2s ease;
        }

        .reset-button:hover {
            transform: rotate(180deg);
        }

        .slider-container {
            position: relative;
            width: 100%;
            height: 60px;
            margin: 10px 0;
        }

        .year-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #2F3E54;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .slider-track-container {
            position: relative;
            width: 100%;
            height: 8px;
            margin: 20px 0;
        }

        .slider-track {
            position: absolute;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            top: 0;
            pointer-events: none;
            display: flex;
            overflow: hidden;
        }

        .legend-segment {
            flex: 1;
            height: 100%;
            position: relative;
        }

        .slider-filled {
            position: absolute;
            height: 8px;
            background: rgba(51, 102, 204, 0.3);
            border-radius: 4px;
            top: 0;
            pointer-events: none;
            transition: all 0.1s ease;
            border: 1px solid rgba(51, 102, 204, 0.5);
        }

        .slider-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
        }

        input[type="range"] {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            pointer-events: none;
            z-index: 2;
            margin: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3366CC;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3366CC;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        input[type="range"]::-webkit-slider-runnable-track {
            background: transparent;
            height: 8px;
        }

        input[type="range"]::-moz-range-track {
            background: transparent;
            height: 8px;
        }

        .handle-label {
            position: absolute;
            top: -28px;
            transform: translateX(-50%);
            background: #3366CC;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            pointer-events: none;
            z-index: 10;
        }

        .handle-label::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #3366CC;
        }

        .handle-label.start {
            background: #3366CC;
        }

        .handle-label.end {
            background: #3366CC;
        }

        .handle-container {
            position: absolute;
            top: 0;
            height: 100%;
        }

    </style>

</head>

<body>
    <div id='map'></div>
    <div id='console'>
        <div class='session' id='sliderbar'>
            <div class="header-row">
                <span class="header-title">Year range</span>
                <span class="year-range-display" id="year-range-display">2001–2024</span>
                <button class="reset-button" id="reset-button" title="Reset">↺</button>
            </div>
            
            <div class="slider-container">
                <div class="year-labels">
                    <span>2001</span>
                    <span>2024</span>
                </div>
                
                <div class="slider-track-container">
                    <div class="slider-track" id="color-legend-track"></div>
                    <div class="slider-filled" id="slider-filled"></div>
                    <div class="slider-wrapper">
                        <div class="handle-container" id="start-handle-container">
                            <div class="handle-label start" id="start-handle-label">Start•2001</div>
                        </div>
                        <div class="handle-container" id="end-handle-container">
                            <div class="handle-label end" id="end-handle-label">End•2024</div>
                        </div>
                        <input id='slider-start' type='range' min='2001' max='2024' step='1' value='2001' />
                        <input id='slider-end' type='range' min='2001' max='2024' step='1' value='2024' />
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script type="text/javascript">
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2xrb3Nvdm8iLCJhIjoiY2tuc3YwNjNuMTJnNDJ1cXdhazVydDZ2cSJ9.QEeEU3pdlV2hBg245jVTJg';

        var map = new mapboxgl.Map({
            container: 'map', // container element id
            style: 'mapbox://styles/mapbox/outdoors-v11',
            center: [20.45710490014006, 42.59902581127422], // initial map center in [lon, lat]
            zoom: 12
        });
        
         // Add zoom and rotation controls to the map.
        map.addControl(new mapboxgl.NavigationControl());

        // disable map rotation using right click + drag
        map.dragRotate.disable();

        // disable map rotation using touch rotation gesture
        map.touchZoomRotate.disableRotation();

        // Color palette function - generates distinct colors for each year
        function getYearColor(year) {
            // Red gradient from light (2001) to dark (2024)
            const colors = {
                2001: '#FFE5E5',  // Very light red
                2002: '#FFCCCC',  // Light red
                2003: '#FFB3B3',  // Light red
                2004: '#FF9999',  // Light-medium red
                2005: '#FF8080',  // Light-medium red
                2006: '#FF6666',  // Medium-light red
                2007: '#FF4D4D',  // Medium-light red
                2008: '#FF3333',  // Medium red
                2009: '#FF1A1A',  // Medium red
                2010: '#FF0000',  // Red
                2011: '#E60000',  // Medium-dark red
                2012: '#CC0000',  // Medium-dark red
                2013: '#B30000',  // Dark red
                2014: '#990000',  // Dark red
                2015: '#800000',  // Dark red
                2016: '#660000',  // Very dark red
                2017: '#4D0000',  // Very dark red
                2018: '#330000',  // Very dark red
                2019: '#1A0000',  // Almost black red
                2020: '#8B0000',  // Dark red (maroon)
                2021: '#7A0000',  // Darker maroon
                2022: '#660000',  // Very dark red
                2023: '#4D0000',  // Very dark red
                2024: '#330000'   // Darkest red (almost black)
            };
            
            return colors[year] || '#b83735'; // Default color if year not found
        }

        // Create color expression for Mapbox
        function createColorExpression() {
            // Build a case expression that maps each year to its color
            const cases = [];
            for (let year = 2001; year <= 2024; year++) {
                cases.push(['==', ['number', ['get', 'year']], year]);
                cases.push(getYearColor(year));
            }
            cases.push('#b83735'); // Default color
            
            return ['case', ...cases];
        }

        // Create color legend on the slider track
        function createColorLegend() {
            const legendTrack = document.getElementById('color-legend-track');
            legendTrack.innerHTML = ''; // Clear existing content
            
            const minYear = 2001;
            const maxYear = 2024;
            
            for (let year = minYear; year <= maxYear; year++) {
                const segment = document.createElement('div');
                segment.className = 'legend-segment';
                segment.style.backgroundColor = getYearColor(year);
                segment.setAttribute('data-year', year);
                segment.title = `Year: ${year}`;
                legendTrack.appendChild(segment);
            }
        }

        // Function to update the filled bar position and handle labels
        function updateSlider() {
            const startSlider = document.getElementById('slider-start');
            const endSlider = document.getElementById('slider-end');
            const filledBar = document.getElementById('slider-filled');
            const startHandleContainer = document.getElementById('start-handle-container');
            const endHandleContainer = document.getElementById('end-handle-container');
            const startHandleLabel = document.getElementById('start-handle-label');
            const endHandleLabel = document.getElementById('end-handle-label');
            const yearRangeDisplay = document.getElementById('year-range-display');
            
            const startValue = parseInt(startSlider.value);
            const endValue = parseInt(endSlider.value);
            const min = parseInt(startSlider.min);
            const max = parseInt(startSlider.max);
            
            const startPercent = ((startValue - min) / (max - min)) * 100;
            const endPercent = ((endValue - min) / (max - min)) * 100;
            
            // Update filled bar
            filledBar.style.left = startPercent + '%';
            filledBar.style.width = (endPercent - startPercent) + '%';
            
            // Update handle positions
            startHandleContainer.style.left = startPercent + '%';
            endHandleContainer.style.left = endPercent + '%';
            
            // Update handle labels
            startHandleLabel.textContent = `Start•${startValue}`;
            endHandleLabel.textContent = `End•${endValue}`;
            
            // Update header range display
            yearRangeDisplay.textContent = `${startValue}–${endValue}`;
        }

        // Function to ensure start <= end
        function constrainSliders() {
            const startSlider = document.getElementById('slider-start');
            const endSlider = document.getElementById('slider-end');
            
            const startValue = parseInt(startSlider.value);
            const endValue = parseInt(endSlider.value);
            
            if (startValue > endValue) {
                if (startSlider === document.activeElement) {
                    endSlider.value = startValue;
                } else {
                    startSlider.value = endValue;
                }
            }
        }

        // Reset function
        function resetSliders() {
            const startSlider = document.getElementById('slider-start');
            const endSlider = document.getElementById('slider-end');
            
            startSlider.value = 2001;
            endSlider.value = 2024;
            
            updateSlider();
            updateMapFilter();
        }

        // Update map filter
        function updateMapFilter() {
            const startYear = parseInt(document.getElementById('slider-start').value);
            const endYear = parseInt(document.getElementById('slider-end').value);
            
            map.setFilter(`forest_layer`, ['all',
                ['>=', ['number', ['get', 'year']], startYear],
                ['<=', ['number', ['get', 'year']], endYear]
            ]);
        }

        map.on('load', function() {
            map.addLayer({
                'id': `forest_layer`,
                'type': 'fill',
                source: {
                    type: 'geojson',
                    //data: `https://rawcdn.githack.com/SLKosovo/slkosovo.github.io/9d68fc218477d0217277466d74d098472d9c69d5/map/slider/deforestation/merged_slk.geojson`                    
                    data: `./deforestation/merged_slk.geojson`                    
                },
                'paint': {
                    'fill-color': createColorExpression(),
                    'fill-opacity': 1
                },
                'filter': ['all',
                    ['>=', ['number', ['get', 'year']], 2001],
                    ['<=', ['number', ['get', 'year']], 2024]
                ]
            });

            const startSlider = document.getElementById('slider-start');
            const endSlider = document.getElementById('slider-end');
            const resetButton = document.getElementById('reset-button');
            
            // Create color legend on slider track
            createColorLegend();
            
            // Initialize slider
            updateSlider();

            // Update map and UI when start slider changes
            startSlider.addEventListener('input', function(e) {
                constrainSliders();
                updateSlider();
                updateMapFilter();
            });

            // Update map and UI when end slider changes
            endSlider.addEventListener('input', function(e) {
                constrainSliders();
                updateSlider();
                updateMapFilter();
            });

            // Reset button
            resetButton.addEventListener('click', resetSliders);
        });

    </script>

</body>

</html>